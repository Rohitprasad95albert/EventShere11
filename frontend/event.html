<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Event Details - EventSphere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* This is the new, corrected CSS for the star rating */
        .star-rating {
            display: flex;
            flex-direction: row-reverse; /* This is key to the hover effect */
            justify-content: center;
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            font-size: 2rem;
            color: #e4e5e9; /* A standard light gray color */
            cursor: pointer;
            transition: color 0.2s;
        }

        /* This is the crucial part that makes the stars light up correctly on hover */
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }

        /* This rule keeps the selected stars yellow after you click */
        .star-rating input:checked ~ label {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <header id="navbar-container"></header>
    <div class="container mt-5" id="event-details-container">
        <p class="text-center text-muted">Loading event details...</p>
    </div>
    <div class="container mt-5" id="reviews-section"></div>

    <script src="config.js"></script>
    <script>
        const eventId = new URLSearchParams(window.location.search).get("id");
        const token = localStorage.getItem("token");
        const userId = localStorage.getItem("userId");
        const headers = { 'Authorization': `Bearer ${token}` };
        const jsonHeaders = { 'Content-Type': 'application/json', ...headers };

        function timeFormatter(timeStr) {
            if (!timeStr) return 'N/A';
            const [hour, minute] = timeStr.split(':');
            return new Date(1970, 0, 1, hour, minute).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        async function handleRegistration(e) {
            e.preventDefault();
            const registerBtn = e.target.querySelector("button[type='submit']");
            registerBtn.disabled = true;
            registerBtn.innerText = 'Processing...';
            const collegeName = document.getElementById("collegeName")?.value.trim() || '';
            try {
                const res = await fetch(`${BASE_URL}/api/events/${eventId}/register`, {
                    method: 'POST',
                    headers: jsonHeaders,
                    body: JSON.stringify({ collegeName })
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error);
                document.getElementById("message").innerText = '✅ Registered Successfully!';
                registerBtn.className = 'btn btn-success w-100';
                registerBtn.innerText = 'Registered';
            } catch (error) {
                document.getElementById("message").innerText = `❌ ${error.message}`;
                registerBtn.disabled = false;
                registerBtn.innerText = 'Register Now';
            }
        }

        async function handleReviewSubmission(e) {
            e.preventDefault();
            const rating = e.target.rating.value;
            const comment = e.target.comment.value;
            if (!rating) {
                alert('Please select a star rating.');
                return;
            }
            try {
                const res = await fetch(`${BASE_URL}/api/feedback/${eventId}`, {
                    method: 'POST',
                    headers: jsonHeaders,
                    body: JSON.stringify({ rating, comment })
                });
                if (!res.ok) throw new Error((await res.json()).error);
                window.location.reload();
            } catch (error) {
                alert(`Error submitting review: ${error.message}`);
            }
        }

        async function loadReviews(event) {
            const reviewsSection = document.getElementById('reviews-section');
            try {
                const res = await fetch(`${BASE_URL}/api/feedback/${eventId}`);
                const reviews = await res.json();
                let averageRating = 0;
                if (reviews.length > 0) {
                    const totalRating = reviews.reduce((acc, review) => acc + review.rating, 0);
                    averageRating = (totalRating / reviews.length).toFixed(1);
                }
                const attendeeRecord = event.attendees.find(a => a.userId?._id === userId);
                const hasAttended = attendeeRecord && attendeeRecord.isAttended;
                const hasAlreadyReviewed = reviews.some(r => r.userId?._id === userId);
                const eventDateTime = new Date(event.date);
                if (event.time) {
                    const [hours, minutes] = event.time.split(':');
                    eventDateTime.setHours(hours, minutes, 0, 0);
                }
                const reviewDeadline = new Date(eventDateTime.getTime() + (24 * 60 * 60 * 1000));
                const canReview = new Date() < reviewDeadline;

                let reviewsHtml = `<h3>Ratings & Reviews (${reviews.length})</h3><hr>`;
                if (reviews.length > 0) {
                    reviewsHtml += `<p class="fs-4">Average Rating: ${averageRating} / 5.0 ⭐</p>`;
                }

                if (hasAttended && !hasAlreadyReviewed && canReview) {
                    reviewsHtml += `
                        <div class="card bg-light p-3 my-4">
                            <h5>Add Your Review</h5>
                            <form id="review-form">
                                <div class="mb-3"><label class="form-label">Your Rating:</label><div class="star-rating"><input type="radio" id="5-stars" name="rating" value="5" required/><label for="5-stars">⭐</label><input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">⭐</label><input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">⭐</label><input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">⭐</label><input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">⭐</label></div></div>
                                <div class="mb-3"><label for="comment" class="form-label">Your Comment:</label><textarea id="comment" name="comment" class="form-control" rows="3"></textarea></div>
                                <button type="submit" class="btn btn-primary">Submit Review</button>
                            </form>
                        </div>`;
                }

                if (reviews.length === 0 && !(hasAttended && !hasAlreadyReviewed)) {
                    reviewsHtml += '<p class="text-muted">No reviews yet.</p>';
                } else {
                    reviews.forEach(review => {
                        reviewsHtml += `
                            <div class="card mb-3"><div class="card-body"><strong>${review.userId?.name || 'Anonymous'}</strong><span class="text-warning float-end">${'⭐'.repeat(review.rating)}</span><p class="card-text mt-2">${review.comment}</p><small class="text-muted">${new Date(review.createdAt).toLocaleDateString()}</small></div></div>`;
                    });
                }
                reviewsSection.innerHTML = reviewsHtml;

                const reviewForm = document.getElementById('review-form');
                if (reviewForm) {
                    reviewForm.addEventListener('submit', handleReviewSubmission);
                }
            } catch (error) {
                reviewsSection.innerHTML = `<p class="text-danger">Could not load reviews.</p>`;
            }
        }

        async function loadEventDetails() {
            const container = document.getElementById('event-details-container');
            try {
                const res = await fetch(`${BASE_URL}/api/events`);
                const events = await res.json();
                const event = events.find(e => e._id === eventId);
                if (!event) throw new Error('Event not found.');

                const isRegistered = userId && (event.attendees || []).some(a => a.userId?._id === userId);
                let regButtonHtml = `<button type="submit" class="btn btn-primary w-100">Register Now</button>`;
                if (isRegistered) regButtonHtml = `<button class="btn btn-success w-100" disabled>Already Registered</button>`;
                if (event.status !== 'approved') regButtonHtml = `<button class="btn btn-secondary w-100" disabled>Registration Closed</button>`;

                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <img src="${BASE_URL}${event.posterUrl}" class="img-fluid rounded mb-3 shadow-sm" onerror="this.style.display='none'">
                            <h2>${event.title}</h2>
                            <p class="text-muted">Organized by: ${event.createdBy?.name || 'University Staff'}</p>
                            <hr>
                            <p>${event.description}</p>
                            <ul class="list-group list-group-flush mt-4">
                                <li class="list-group-item"><strong>Date & Time:</strong> ${new Date(event.date).toLocaleDateString()} at ${timeFormatter(event.time)}</li>
                                <li class="list-group-item"><strong>Venue:</strong> ${event.venue}</li>
                                <li class="list-group-item"><strong>Mode:</strong> ${event.eventMode}</li>
                                <li class="list-group-item"><strong>Category:</strong> ${event.type}</li>
                                <li class="list-group-item"><strong>Competition Type:</strong> ${event.competitionType}</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Registration Details</h5>
                                    <hr>
                                    <p><strong>Fee:</strong> ${event.registrationFee > 0 ? `₹${event.registrationFee}`: 'Free'}</p>
                                    <p><strong>Slots Filled:</strong> ${(event.attendees || []).length} / ${event.registrationLimit > 0 ? event.registrationLimit : 'Unlimited'}</p>
                                    <form id="registration-form" class="mt-3">
                                      ${(event.competitionType === 'Inter College' && !isRegistered) ? `<div class="mb-3"><label class="form-label">College Name</label><input type="text" id="collegeName" class="form-control" required></div>` : ''}
                                      ${regButtonHtml}
                                      <p id="message" class="mt-2 text-center"></p>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                document.getElementById('registration-form').addEventListener('submit', handleRegistration);
                
                // This is the crucial change:
                // We call loadReviews only after the main event details are loaded.
                loadReviews(event);

            } catch (error) { 
                container.innerHTML = `<p class="text-danger text-center"><strong>Error:</strong> ${error.message}</p>`; 
            }
        }
        
        document.addEventListener("DOMContentLoaded", loadEventDetails);
    </script>
    <script src="navbar.js"></script>
</body>
</html>